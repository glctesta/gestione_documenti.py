# label_printing_gui.py
"""
Modulo per la gestione della stampa etichette.
Gestisce:
- Selezione ordini per stampa etichette
- Impostazioni stampante (da implementare)
- Configurazione etichette (dimensioni e campi)
"""

import tkinter as tk
from tkinter import ttk, messagebox
import logging

logger = logging.getLogger("TraceabilityRS")


def open_label_print_window(parent, db, lang, user_name):
    """Apre la finestra di stampa etichette."""
    LabelPrintWindow(parent, db, lang, user_name)


def open_printer_settings_window(parent, db, lang, user_name):
    """Apre la finestra impostazioni stampante."""
    PrinterSettingsWindow(parent, db, lang, user_name)


def open_label_config_window(parent, db, lang, user_name):
    """Apre la finestra di configurazione etichetta."""
    from label_config_window import LabelConfigWindow
    LabelConfigWindow(parent, db, lang, user_name)



class LabelPrintWindow(tk.Toplevel):
    """Finestra per la stampa etichette."""
    
    def __init__(self, parent, db, lang, user_name):
        logger.info(f"LabelPrintWindow: Apertura finestra stampa etichette (user: {user_name})")
        super().__init__(parent)
        self.db = db
        self.lang = lang
        self.user_name = user_name
        
        self.title(self.lang.get('label_print_window_title', 'Stampa Etichette'))
        self.geometry('900x450')
        self.transient(parent)
        self.grab_set()
        
        self.selected_order_id = None
        self.selected_order_number = None
        self.orders_dict = {}
        self.label_data = []
        self.phases_list = []
        
        self._create_widgets()
        self._load_orders()
    
    def _create_widgets(self):
        """Crea i widget della finestra."""
        # Header con nome utente
        header = ttk.Frame(self)
        header.pack(fill='x', padx=10, pady=5)
        ttk.Label(header, text=f"{self.lang.get('logged_user', 'Utente')}: {self.user_name}",
                  font=('Arial', 10, 'bold')).pack(side='left')
        
        # Frame principale
        main_frame = ttk.Frame(self, padding="20")
        main_frame.pack(fill='both', expand=True)
        
        # Selezione ordine
        ttk.Label(main_frame, text=self.lang.get('order_label', 'Ordine') + ' *').grid(
            row=0, column=0, sticky='w', padx=5, pady=5)
        
        self.order_combo = ttk.Combobox(main_frame, state='readonly', width=40)
        self.order_combo.grid(row=0, column=1, padx=5, pady=5, sticky='ew')
        self.order_combo.bind('<<ComboboxSelected>>', self._on_order_selected)
        
        # Frame per informazioni ordine
        info_frame = ttk.LabelFrame(main_frame, text=self.lang.get('order_info', 'Informazioni Ordine'), 
                                     padding="10")
        info_frame.grid(row=1, column=0, columnspan=2, sticky='ew', padx=5, pady=10)
        
        # Numero ordine
        ttk.Label(info_frame, text=self.lang.get('order_number', 'Numero Ordine') + ':').grid(
            row=0, column=0, sticky='w', padx=5, pady=2)
        self.order_number_label = ttk.Label(info_frame, text='-', font=('Arial', 9, 'bold'))
        self.order_number_label.grid(row=0, column=1, sticky='w', padx=5, pady=2)
        
        # Codice prodotto
        ttk.Label(info_frame, text=self.lang.get('product_code', 'Codice Prodotto') + ':').grid(
            row=1, column=0, sticky='w', padx=5, pady=2)
        self.product_code_label = ttk.Label(info_frame, text='-', font=('Arial', 9, 'bold'))
        self.product_code_label.grid(row=1, column=1, sticky='w', padx=5, pady=2)
        
        # Quantit√†
        ttk.Label(info_frame, text=self.lang.get('quantity', 'Quantit√†') + ':').grid(
            row=2, column=0, sticky='w', padx=5, pady=2)
        self.quantity_label = ttk.Label(info_frame, text='-', font=('Arial', 9, 'bold'))
        self.quantity_label.grid(row=2, column=1, sticky='w', padx=5, pady=2)
        
        # Selezione fase
        ttk.Label(main_frame, text=self.lang.get('phase_label', 'Fase') + ' *').grid(
            row=2, column=0, sticky='w', padx=5, pady=5)
        
        self.phase_combo = ttk.Combobox(main_frame, state='disabled', width=40)
        self.phase_combo.grid(row=2, column=1, padx=5, pady=5, sticky='ew')
        self.phase_combo.bind('<<ComboboxSelected>>', self._on_phase_selected)
        
        # Label per conteggio componenti
        ttk.Label(main_frame, text=self.lang.get('components_count_label', 'Componenti disponibili') + ':').grid(
            row=2, column=2, sticky='w', padx=5, pady=5)
        self.components_count_label = ttk.Label(main_frame, text='-', font=('Arial', 9, 'bold'))
        self.components_count_label.grid(row=2, column=3, sticky='w', padx=5, pady=2)
        
        # Codice componente
        ttk.Label(main_frame, text=self.lang.get('component_code', 'Codice Componente') + ' *').grid(
            row=3, column=0, sticky='w', padx=5, pady=5)
        
        self.component_code_var = tk.StringVar()
        self.component_code_entry = ttk.Entry(main_frame, textvariable=self.component_code_var, width=40)
        self.component_code_entry.grid(row=3, column=1, padx=5, pady=5, sticky='ew')
        
        main_frame.columnconfigure(1, weight=1)
        
        # Spacer
        ttk.Label(main_frame, text='').grid(row=4, column=0, columnspan=2, pady=10)
        
        # Frame pulsanti
        button_frame = ttk.Frame(self, padding="10")
        button_frame.pack(fill='x', padx=10, pady=10)
        
        ttk.Button(button_frame, text=self.lang.get('print_button', 'Stampa'),
                  command=self._on_print).pack(side='right', padx=5)
        ttk.Button(button_frame, text=self.lang.get('cancel_button', 'Annulla'),
                  command=self._on_cancel).pack(side='right', padx=5)
    
    def _load_orders(self):
        """Carica gli ordini dal database."""
        try:
            cursor = self.db.conn.cursor()
            query = """
            SELECT IDOrder, OrderNumber
            FROM [Traceability_RS].[dbo].[Orders] o
            OUTER APPLY
                (SELECT NoBoards FROM [Traceability_RS].[dbo].QuantitaProdottaPerFase (o.IDOrder, 4)) AS K
            WHERE CAST(o.orderdate AS DATE) >= '2025-10-01'
            AND k.NoBoards=0
            ORDER BY OrderNumber DESC
            """
            cursor.execute(query)
            rows = cursor.fetchall()
            cursor.close()
            
            # Popola il dizionario e il combo
            self.orders_dict = {}
            order_list = []
            
            for row in rows:
                order_id, order_number = row
                self.orders_dict[order_number] = order_id
                order_list.append(order_number)
            
            self.order_combo['values'] = order_list
            
            if order_list:
                logger.info(f"Caricati {len(order_list)} ordini")
            else:
                logger.warning("Nessun ordine trovato dal 2025-10-01 con NoBoards=0")
                messagebox.showinfo(
                    self.lang.get('info_title', 'Informazione'),
                    self.lang.get('no_orders_found', 'Nessun ordine trovato dal 2025-10-01 senza produzione'),
                    parent=self
                )
        
        except Exception as e:
            logger.error(f"Errore caricamento ordini: {e}")
            messagebox.showerror(
                self.lang.get('error_title', 'Errore'),
                f"Errore caricamento ordini:\n{e}",
                parent=self
            )
    
    def _on_order_selected(self, event=None):
        """Gestisce la selezione di un ordine."""
        order_number = self.order_combo.get()
        if order_number:
            self.selected_order_id = self.orders_dict.get(order_number)
            self.selected_order_number = order_number
            logger.info(f"Ordine selezionato: {order_number} (ID: {self.selected_order_id})")
            
            # Carica i dati dell'ordine
            self._load_order_data()
    
    def _on_phase_selected(self, event=None):
        """Gestisce la selezione di una fase."""
        selected_phase = self.phase_combo.get()
        if selected_phase:
            logger.info(f"Fase selezionata: {selected_phase}")
            self._update_components_count()
    
    def _update_components_count(self):
        """Aggiorna il conteggio dei componenti per la fase selezionata."""
        selected_phase = self.phase_combo.get()
        
        if not selected_phase or not self.label_data:
            self.components_count_label.config(text='-')
            return
        
        # Filtra i componenti per la fase selezionata
        filtered_components = [
            d for d in self.label_data 
            if d['ParentPhaseName'] == selected_phase
        ]
        
        # Conta i componenti unici
        unique_components = set(d['ComponentCode'] for d in filtered_components)
        count = len(unique_components)
        
        # Aggiorna il label
        self.components_count_label.config(text=str(count))
        logger.info(f"Componenti per fase '{selected_phase}': {count}")
    
    def _load_order_data(self):
        """Carica i dati dell'ordine selezionato."""
        try:
            cursor = self.db.conn.cursor()
            
            # Query con i dettagli componenti e riferimenti
            query = """
            DECLARE @Ordernumber VARCHAR(250) = ?;

            WITH AggregatedRiferimenti AS (
                SELECT
                    PCE.IDProduct,
                    PCE.IDComponent,
                    STUFF(
                        (SELECT DISTINCT ', ' + PR.CodRiferimento
                         FROM ProductRiferiments PR
                         INNER JOIN ProductComponentsErp PCE_inner ON PR.IDProductCompErp = PCE_inner.IDProductCompErp
                         WHERE PCE_inner.IDProduct = PCE.IDProduct
                           AND PCE_inner.IDComponent = PCE.IDComponent
                         FOR XML PATH(''), TYPE
                        ).value('.', 'NVARCHAR(MAX)')
                    , 1, 2, '') AS CodRiferimentiConcatenati
                FROM ProductComponentsErp PCE
                GROUP BY
                    PCE.IDProduct,
                    PCE.IDComponent
            )
            SELECT
                P.ProductCode,
                O.OrderNumber,
                O.OrderQuantity,
                C.ComponentCode,
                x.ComponentQuantity,
                AR.CodRiferimentiConcatenati,
                pp.ParentPhaseName
            FROM Orders O
            INNER JOIN Products P ON P.IDProduct = O.IDProduct
            INNER JOIN ProductComponentsErp PCE ON PCE.IDProduct = P.IDProduct
            INNER JOIN ProductRiferiments PR ON PR.IDProductCompErp = PCE.IDProductCompErp
            INNER JOIN Components C ON PCE.IDComponent = C.IDComponent
            INNER JOIN ParentPhases pp ON pp.IDParentPhase = PR.IDParentPhase
            LEFT JOIN AggregatedRiferimenti AR ON AR.IDProduct = PCE.IDProduct AND AR.IDComponent = PCE.IDComponent
            WHERE O.OrderNumber = @Ordernumber
            GROUP BY
                O.IDProduct,
                P.ProductCode,
                O.IDOrder,
                O.OrderNumber,
                O.OrderQuantity,
                C.ComponentCode,
                AR.CodRiferimentiConcatenati,
                pp.ParentPhaseName
            """
            
            cursor.execute(query, self.selected_order_number)
            rows = cursor.fetchall()
            cursor.close()
            
            if rows:
                # Salva i dati
                self.label_data = []
                phases_set = set()
                
                product_code = None
                order_number = None
                order_quantity = None
                
                for row in rows:
                    product_code, order_number, order_quantity, component_code, component_quantity, cod_riferimenti, parent_phase = row
                    
                    self.label_data.append({
                        'ProductCode': product_code,
                        'OrderNumber': order_number,
                        'OrderQuantity': order_quantity,
                        'ComponentCode': component_code,
                        'ComponentQuantity': component_quantity,
                        'CodRiferimenti': cod_riferimenti,
                        'ParentPhaseName': parent_phase
                    })
                    
                    if parent_phase:
                        phases_set.add(parent_phase)
                
                # Aggiorna le label con le informazioni ordine
                self.order_number_label.config(text=order_number or '-')
                self.product_code_label.config(text=product_code or '-')
                self.quantity_label.config(text=str(order_quantity) if order_quantity else '-')
                
                # Popola il combo delle fasi
                self.phases_list = sorted(list(phases_set))
                self.phase_combo['values'] = self.phases_list
                
                # Imposta PTHM come default se presente, altrimenti la prima fase
                if 'PTHM' in self.phases_list:
                    self.phase_combo.set('PTHM')
                elif self.phases_list:
                    self.phase_combo.set(self.phases_list[0])
                
                self.phase_combo.config(state='readonly')
                
                # Aggiorna il conteggio dei componenti per la fase selezionata
                self._update_components_count()
                
                logger.info(f"Caricati {len(self.label_data)} record per ordine {order_number}")
                logger.info(f"Fasi trovate: {len(phases_set)}")
            else:
                logger.warning(f"Nessun dato trovato per ordine {self.selected_order_number}")
                messagebox.showwarning(
                    self.lang.get('warning_title', 'Attenzione'),
                    self.lang.get('no_data_for_order', 'Nessun dato trovato per questo ordine'),
                    parent=self
                )
                # Reset
                self._reset_order_info()
        
        except Exception as e:
            logger.error(f"Errore caricamento dati ordine: {e}")
            messagebox.showerror(
                self.lang.get('error_title', 'Errore'),
                f"Errore caricamento dati ordine:\n{e}",
                parent=self
            )
            self._reset_order_info()
    
    def _reset_order_info(self):
        """Reset delle informazioni ordine."""
        self.order_number_label.config(text='-')
        self.product_code_label.config(text='-')
        self.quantity_label.config(text='-')
        self.phase_combo.set('')
        self.phase_combo['values'] = []
        self.phase_combo.config(state='disabled')
        self.components_count_label.config(text='-')
        self.label_data = []
        self.phases_list = []
    
    def _on_print(self):
        """Gestisce il click sul pulsante Stampa."""
        # Validazione
        if not self.order_combo.get():
            messagebox.showwarning(
                self.lang.get('warning_title', 'Attenzione'),
                self.lang.get('select_order', 'Seleziona un ordine'),
                parent=self
            )
            return
        
        if not self.phase_combo.get():
            messagebox.showwarning(
                self.lang.get('warning_title', 'Attenzione'),
                self.lang.get('select_phase', 'Seleziona una fase'),
                parent=self
            )
            return
        
        # Validazione codice componente
        component_code = self.component_code_var.get().strip()
        if not component_code:
            messagebox.showwarning(
                self.lang.get('warning_title', 'Attenzione'),
                self.lang.get('enter_component_code', 'Inserisci il codice componente'),
                parent=self
            )
            return
        
        # Filtra i dati in base alla fase selezionata
        selected_phase = self.phase_combo.get()
        filtered_data = [d for d in self.label_data if d['ParentPhaseName'] == selected_phase]
        
        # Filtra per codice componente
        component_data = [d for d in filtered_data if d['ComponentCode'] == component_code]
        
        if not component_data:
            messagebox.showwarning(
                self.lang.get('warning_title', 'Attenzione'),
                self.lang.get('component_not_found', f'Componente "{component_code}" non trovato per la fase selezionata'),
                parent=self
            )
            return
        
        # Prendi il primo record (dovrebbe essere unico per componente+fase)
        label_to_print = component_data[0]
        
        # TODO: Implementare la stampa dell'etichetta
        # Per ora mostra un messaggio placeholder con i dati
        data_summary = f"Etichetta da stampare:\n\n"
        data_summary += f"Ordine: {label_to_print['OrderNumber']}\n"
        data_summary += f"Prodotto: {label_to_print['ProductCode']}\n"
        data_summary += f"Quantit√†: {label_to_print['OrderQuantity']}\n"
        data_summary += f"Componente: {label_to_print['ComponentCode']}\n"
        data_summary += f"Fase: {label_to_print['ParentPhaseName']}\n"
        data_summary += f"Riferimenti: {label_to_print['CodRiferimenti'] or 'N/A'}\n\n"
        data_summary += "Funzionalit√† di stampa da implementare."
        
        messagebox.showinfo(
            self.lang.get('info_title', 'Informazione'),
            data_summary,
            parent=self
        )
        
        logger.info(f"Richiesta stampa etichetta - Ordine: {self.selected_order_number}, "
                   f"Componente: {component_code}, Fase: {selected_phase}")

    
    def _on_cancel(self):
        """Chiude la finestra."""
        logger.info("LabelPrintWindow: Chiusura finestra")
        self.destroy()


class PrinterSettingsWindow(tk.Toplevel):
    """Finestra per le impostazioni della stampante."""
    
    def __init__(self, parent, db, lang, user_name):
        logger.info(f"PrinterSettingsWindow: Apertura finestra impostazioni (user: {user_name})")
        super().__init__(parent)
        self.db = db
        self.lang = lang
        self.user_name = user_name
        
        self.title(self.lang.get('printer_settings_window_title', 'Impostazioni Stampante'))
        self.geometry('700x500')
        self.transient(parent)
        self.grab_set()
        
        # Importa i moduli necessari
        from printer_config import PrinterConfigManager
        from printer_connection_manager import get_available_printers, get_default_printer
        
        self.config_manager = PrinterConfigManager()
        self.get_available_printers = get_available_printers
        self.get_default_printer = get_default_printer
        
        self._create_widgets()
        self._load_current_config()
    
    def _create_widgets(self):
        """Crea i widget della finestra."""
        # Header con nome utente
        header = ttk.Frame(self)
        header.pack(fill='x', padx=10, pady=5)
        ttk.Label(header, text=f"{self.lang.get('logged_user', 'Utente')}: {self.user_name}",
                  font=('Arial', 10, 'bold')).pack(side='left')
        
        # Frame principale
        main_frame = ttk.Frame(self, padding="20")
        main_frame.pack(fill='both', expand=True)
        
        # Titolo
        ttk.Label(main_frame, text=self.lang.get('select_printer_type', 'Seleziona tipo di connessione stampante:'),
                  font=('Arial', 11, 'bold')).pack(anchor='w', pady=(0, 10))
        
        # Radio buttons per tipo connessione
        self.connection_type_var = tk.StringVar(value='DEFAULT')
        
        radio_frame = ttk.Frame(main_frame)
        radio_frame.pack(fill='x', pady=10)
        
        ttk.Radiobutton(radio_frame, text=self.lang.get('default_printer', 'üñ®Ô∏è Stampante di Default Windows'),
                       variable=self.connection_type_var, value='DEFAULT',
                       command=self._on_connection_type_changed).pack(anchor='w', pady=5)
        
        ttk.Radiobutton(radio_frame, text=self.lang.get('usb_printer', 'üîå Stampante USB (Zebra/Brother)'),
                       variable=self.connection_type_var, value='USB',
                       command=self._on_connection_type_changed).pack(anchor='w', pady=5)
        
        ttk.Radiobutton(radio_frame, text=self.lang.get('ip_printer', 'üåê Stampante IP/Network'),
                       variable=self.connection_type_var, value='IP',
                       command=self._on_connection_type_changed).pack(anchor='w', pady=5)
        
        # Separator
        ttk.Separator(main_frame, orient='horizontal').pack(fill='x', pady=15)
        
        # Frame per configurazione dinamica
        self.config_frame = ttk.LabelFrame(main_frame, text=self.lang.get('printer_config', 'Configurazione'),
                                           padding="15")
        self.config_frame.pack(fill='both', expand=True, pady=10)
        
        # --- Frame per Default Printer ---
        self.default_frame = ttk.Frame(self.config_frame)
        
        ttk.Label(self.default_frame, text=self.lang.get('current_default_printer', 'Stampante di default corrente:'),
                  font=('Arial', 9)).grid(row=0, column=0, sticky='w', pady=5)
        
        self.default_printer_label = ttk.Label(self.default_frame, text='-', 
                                               font=('Arial', 9, 'bold'), foreground='blue')
        self.default_printer_label.grid(row=0, column=1, sticky='w', padx=10, pady=5)
        
        ttk.Button(self.default_frame, text='üîÑ ' + self.lang.get('refresh', 'Aggiorna'),
                  command=self._refresh_default_printer).grid(row=0, column=2, padx=5)
        
        ttk.Label(self.default_frame, 
                  text=self.lang.get('default_printer_info', 
                                    'La stampante di default di Windows verr√† utilizzata per la stampa.'),
                  wraplength=500, justify='left').grid(row=1, column=0, columnspan=3, sticky='w', pady=10)
        
        # --- Frame per USB Printer ---
        self.usb_frame = ttk.Frame(self.config_frame)
        
        ttk.Label(self.usb_frame, text=self.lang.get('select_usb_printer', 'Seleziona stampante USB:') + ' *').grid(
            row=0, column=0, sticky='w', pady=5)
        
        self.usb_printer_combo = ttk.Combobox(self.usb_frame, state='readonly', width=40)
        self.usb_printer_combo.grid(row=0, column=1, padx=5, pady=5, sticky='ew')
        
        ttk.Button(self.usb_frame, text='üîç ' + self.lang.get('detect_printers', 'Rileva Stampanti'),
                  command=self._detect_usb_printers).grid(row=0, column=2, padx=5)
        
        ttk.Label(self.usb_frame, text=self.lang.get('printer_model', 'Modello:') + ' *').grid(
            row=1, column=0, sticky='w', pady=5)
        
        self.printer_model_var = tk.StringVar(value='ZEBRA')
        model_frame = ttk.Frame(self.usb_frame)
        model_frame.grid(row=1, column=1, sticky='w', pady=5)
        ttk.Radiobutton(model_frame, text='Zebra', variable=self.printer_model_var, 
                       value='ZEBRA').pack(side='left', padx=5)
        ttk.Radiobutton(model_frame, text='Brother', variable=self.printer_model_var, 
                       value='BROTHER').pack(side='left', padx=5)
        
        self.usb_frame.columnconfigure(1, weight=1)
        
        # --- Frame per IP Printer ---
        self.ip_frame = ttk.Frame(self.config_frame)
        
        ttk.Label(self.ip_frame, text=self.lang.get('printer_ip', 'Indirizzo IP:') + ' *').grid(
            row=0, column=0, sticky='w', pady=5)
        
        self.ip_var = tk.StringVar()
        ttk.Entry(self.ip_frame, textvariable=self.ip_var, width=20).grid(
            row=0, column=1, padx=5, pady=5, sticky='w')
        
        ttk.Label(self.ip_frame, text=self.lang.get('printer_port', 'Porta:') + ' *').grid(
            row=1, column=0, sticky='w', pady=5)
        
        self.port_var = tk.StringVar(value='9100')
        ttk.Entry(self.ip_frame, textvariable=self.port_var, width=10).grid(
            row=1, column=1, padx=5, pady=5, sticky='w')
        
        ttk.Label(self.ip_frame, text=self.lang.get('ip_printer_info', 
                                                     '(Porta standard: 9100 per Zebra, 9100 per Brother)'),
                  font=('Arial', 8), foreground='gray').grid(row=2, column=0, columnspan=2, sticky='w', pady=5)
        
        # Mostra il frame di default inizialmente
        self.default_frame.pack(fill='both', expand=True)
        
        # Frame pulsanti
        button_frame = ttk.Frame(self, padding="10")
        button_frame.pack(fill='x', padx=10, pady=10)
        
        ttk.Button(button_frame, text='üß™ ' + self.lang.get('test_connection', 'Test Connessione'),
                  command=self._test_connection).pack(side='left', padx=5)
        
        ttk.Button(button_frame, text='üíæ ' + self.lang.get('save_button', 'Salva'),
                  command=self._save_config).pack(side='right', padx=5)
        ttk.Button(button_frame, text='‚ùå ' + self.lang.get('cancel_button', 'Annulla'),
                  command=self.destroy).pack(side='right', padx=5)
    
    def _on_connection_type_changed(self):
        """Gestisce il cambio di tipo connessione"""
        # Nascondi tutti i frame
        self.default_frame.pack_forget()
        self.usb_frame.pack_forget()
        self.ip_frame.pack_forget()
        
        # Mostra il frame appropriato
        conn_type = self.connection_type_var.get()
        if conn_type == 'DEFAULT':
            self.default_frame.pack(fill='both', expand=True)
            self._refresh_default_printer()
        elif conn_type == 'USB':
            self.usb_frame.pack(fill='both', expand=True)
            self._detect_usb_printers()
        elif conn_type == 'IP':
            self.ip_frame.pack(fill='both', expand=True)
    
    def _refresh_default_printer(self):
        """Aggiorna la stampante di default"""
        default_printer = self.get_default_printer()
        if default_printer:
            self.default_printer_label.config(text=default_printer)
            logger.info(f"Stampante di default: {default_printer}")
        else:
            self.default_printer_label.config(text=self.lang.get('no_default_printer', 'Nessuna stampante di default'))
            logger.warning("Nessuna stampante di default trovata")
    
    def _detect_usb_printers(self):
        """Rileva le stampanti USB disponibili"""
        printers = self.get_available_printers()
        if printers:
            self.usb_printer_combo['values'] = printers
            logger.info(f"Rilevate {len(printers)} stampanti")
        else:
            self.usb_printer_combo['values'] = []
            messagebox.showwarning(
                self.lang.get('warning_title', 'Attenzione'),
                self.lang.get('no_printers_found', 'Nessuna stampante rilevata sul sistema'),
                parent=self
            )
    
    def _load_current_config(self):
        """Carica la configurazione corrente"""
        config = self.config_manager.get_config()
        conn_type = config.get('connection_type', 'DEFAULT')
        
        self.connection_type_var.set(conn_type)
        
        if conn_type == 'USB':
            self.usb_printer_combo.set(config.get('usb_printer_name', ''))
            self.printer_model_var.set(config.get('printer_model', 'ZEBRA'))
        elif conn_type == 'IP':
            self.ip_var.set(config.get('ip', ''))
            self.port_var.set(str(config.get('port', 9100)))
        
        self._on_connection_type_changed()
        logger.info(f"Configurazione caricata: {conn_type}")
    
    def _test_connection(self):
        """Testa la connessione alla stampante"""
        from printer_connection_manager import get_printer_connection, PrinterConnectionError
        
        conn_type = self.connection_type_var.get()
        
        try:
            # Crea la configurazione di test
            if conn_type == 'DEFAULT':
                config = {'connection_type': 'DEFAULT'}
            elif conn_type == 'USB':
                usb_printer = self.usb_printer_combo.get()
                if not usb_printer:
                    messagebox.showwarning(
                        self.lang.get('warning_title', 'Attenzione'),
                        self.lang.get('select_usb_printer', 'Seleziona una stampante USB'),
                        parent=self
                    )
                    return
                config = {
                    'connection_type': 'USB',
                    'usb_printer_name': usb_printer,
                    'printer_model': self.printer_model_var.get()
                }
            elif conn_type == 'IP':
                if not self.ip_var.get():
                    messagebox.showwarning(
                        self.lang.get('warning_title', 'Attenzione'),
                        self.lang.get('enter_ip', 'Inserisci l\'indirizzo IP'),
                        parent=self
                    )
                    return
                try:
                    port = int(self.port_var.get())
                except ValueError:
                    messagebox.showwarning(
                        self.lang.get('warning_title', 'Attenzione'),
                        self.lang.get('invalid_port', 'Porta non valida'),
                        parent=self
                    )
                    return
                config = {
                    'connection_type': 'IP',
                    'ip': self.ip_var.get(),
                    'port': port
                }
            
            # Testa la connessione
            printer_conn = get_printer_connection(config)
            if printer_conn.test_connection():
                messagebox.showinfo(
                    self.lang.get('success_title', 'Successo'),
                    self.lang.get('connection_test_success', 'Test connessione riuscito!\n\n') + 
                    printer_conn.get_status(),
                    parent=self
                )
                logger.info("Test connessione stampante riuscito")
            else:
                messagebox.showerror(
                    self.lang.get('error_title', 'Errore'),
                    self.lang.get('connection_test_failed', 'Test connessione fallito'),
                    parent=self
                )
        except PrinterConnectionError as e:
            messagebox.showerror(
                self.lang.get('error_title', 'Errore'),
                f"{self.lang.get('connection_error', 'Errore di connessione')}:\n{str(e)}",
                parent=self
            )
        except Exception as e:
            logger.error(f"Errore test connessione: {e}", exc_info=True)
            messagebox.showerror(
                self.lang.get('error_title', 'Errore'),
                f"{self.lang.get('test_error', 'Errore durante il test')}:\n{str(e)}",
                parent=self
            )
    
    def _save_config(self):
        """Salva la configurazione"""
        conn_type = self.connection_type_var.get()
        
        try:
            if conn_type == 'DEFAULT':
                self.config_manager.update_default_config()
            elif conn_type == 'USB':
                usb_printer = self.usb_printer_combo.get()
                if not usb_printer:
                    messagebox.showwarning(
                        self.lang.get('warning_title', 'Attenzione'),
                        self.lang.get('select_usb_printer', 'Seleziona una stampante USB'),
                        parent=self
                    )
                    return
                self.config_manager.update_usb_config(usb_printer, self.printer_model_var.get())
            elif conn_type == 'IP':
                if not self.ip_var.get():
                    messagebox.showwarning(
                        self.lang.get('warning_title', 'Attenzione'),
                        self.lang.get('enter_ip', 'Inserisci l\'indirizzo IP'),
                        parent=self
                    )
                    return
                try:
                    port = int(self.port_var.get())
                except ValueError:
                    messagebox.showwarning(
                        self.lang.get('warning_title', 'Attenzione'),
                        self.lang.get('invalid_port', 'Porta non valida'),
                        parent=self
                    )
                    return
                self.config_manager.update_ip_config(self.ip_var.get(), port)
            
            messagebox.showinfo(
                self.lang.get('success_title', 'Successo'),
                self.lang.get('config_saved', 'Configurazione salvata con successo!'),
                parent=self
            )
            logger.info(f"Configurazione stampante salvata: {conn_type}")
            self.destroy()
            
        except Exception as e:
            logger.error(f"Errore salvataggio configurazione: {e}", exc_info=True)
            messagebox.showerror(
                self.lang.get('error_title', 'Errore'),
                f"{self.lang.get('save_error', 'Errore durante il salvataggio')}:\n{str(e)}",
                parent=self
            )

 
 
 
 c l a s s   L a b e l C o n f i g W i n d o w ( t k . T o p l e v e l ) : 
 
         " " " F i n e s t r a   p e r   l a   c o n f i g u r a z i o n e   d e l l e   e t i c h e t t e . " " " 
 
         
 
         d e f   _ _ i n i t _ _ ( s e l f ,   p a r e n t ,   d b ,   l a n g ,   u s e r _ n a m e ) : 
 
                 l o g g e r . i n f o ( f " L a b e l C o n f i g W i n d o w :   A p e r t u r a   f i n e s t r a   c o n f i g u r a z i o n e   ( u s e r :   { u s e r _ n a m e } ) " ) 
 
                 s u p e r ( ) . _ _ i n i t _ _ ( p a r e n t ) 
 
                 s e l f . d b   =   d b 
 
                 s e l f . l a n g   =   l a n g 
 
                 s e l f . u s e r _ n a m e   =   u s e r _ n a m e 
 
                 
 
                 s e l f . t i t l e ( s e l f . l a n g . g e t ( ' l a b e l _ c o n f i g _ w i n d o w _ t i t l e ' ,   ' C o n f i g u r a z i o n e   E t i c h e t t a ' ) ) 
 
                 s e l f . g e o m e t r y ( ' 7 0 0 x 6 0 0 ' ) 
 
                 s e l f . t r a n s i e n t ( p a r e n t ) 
 
                 s e l f . g r a b _ s e t ( ) 
 
                 
 
                 s e l f . c o n f i g _ i d   =   N o n e 
 
                 
 
                 s e l f . _ c r e a t e _ w i d g e t s ( ) 
 
                 s e l f . _ l o a d _ c o n f i g u r a t i o n ( ) 
 
         
 
         d e f   _ c r e a t e _ w i d g e t s ( s e l f ) : 
 
                 " " " C r e a   i   w i d g e t   d e l l a   f i n e s t r a . " " " 
 
                 #   H e a d e r   c o n   n o m e   u t e n t e 
 
                 h e a d e r   =   t t k . F r a m e ( s e l f ) 
 
                 h e a d e r . p a c k ( f i l l = ' x ' ,   p a d x = 1 0 ,   p a d y = 5 ) 
 
                 t t k . L a b e l ( h e a d e r ,   t e x t = f " { s e l f . l a n g . g e t ( ' l o g g e d _ u s e r ' ,   ' U t e n t e ' ) } :   { s e l f . u s e r _ n a m e } " , 
 
                                     f o n t = ( ' A r i a l ' ,   1 0 ,   ' b o l d ' ) ) . p a c k ( s i d e = ' l e f t ' ) 
 
                 
 
                 #   F r a m e   p r i n c i p a l e   c o n   s c r o l l b a r 
 
                 m a i n _ c a n v a s   =   t k . C a n v a s ( s e l f ) 
 
                 s c r o l l b a r   =   t t k . S c r o l l b a r ( s e l f ,   o r i e n t = " v e r t i c a l " ,   c o m m a n d = m a i n _ c a n v a s . y v i e w ) 
 
                 s c r o l l a b l e _ f r a m e   =   t t k . F r a m e ( m a i n _ c a n v a s ) 
 
                 
 
                 s c r o l l a b l e _ f r a m e . b i n d ( 
 
                         " < C o n f i g u r e > " , 
 
                         l a m b d a   e :   m a i n _ c a n v a s . c o n f i g u r e ( s c r o l l r e g i o n = m a i n _ c a n v a s . b b o x ( " a l l " ) ) 
 
                 ) 
 
                 
 
                 m a i n _ c a n v a s . c r e a t e _ w i n d o w ( ( 0 ,   0 ) ,   w i n d o w = s c r o l l a b l e _ f r a m e ,   a n c h o r = " n w " ) 
 
                 m a i n _ c a n v a s . c o n f i g u r e ( y s c r o l l c o m m a n d = s c r o l l b a r . s e t ) 
 
                 
 
                 m a i n _ c a n v a s . p a c k ( s i d e = " l e f t " ,   f i l l = " b o t h " ,   e x p a n d = T r u e ,   p a d x = 1 0 ,   p a d y = 1 0 ) 
 
                 s c r o l l b a r . p a c k ( s i d e = " r i g h t " ,   f i l l = " y " ) 
 
                 
 
                 #   = = =   S E Z I O N E   D I M E N S I O N I   E T I C H E T T A   = = = 
 
                 d i m e n s i o n s _ f r a m e   =   t t k . L a b e l F r a m e ( s c r o l l a b l e _ f r a m e ,   
 
                                                                                   t e x t = s e l f . l a n g . g e t ( ' l a b e l _ d i m e n s i o n s _ s e c t i o n ' ,   ' D i m e n s i o n i   E t i c h e t t a ' ) , 
 
                                                                                   p a d d i n g = " 1 5 " ) 
 
                 d i m e n s i o n s _ f r a m e . p a c k ( f i l l = ' x ' ,   p a d x = 1 0 ,   p a d y = 1 0 ) 
 
                 
 
                 #   L a r g h e z z a 
 
                 t t k . L a b e l ( d i m e n s i o n s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' l a b e l _ w i d t h ' ,   ' L a r g h e z z a   ( c m ) ' )   +   ' : ' ) . g r i d ( 
 
                         r o w = 0 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . w i d t h _ v a r   =   t k . D o u b l e V a r ( v a l u e = 1 0 . 0 ) 
 
                 w i d t h _ s p i n b o x   =   t t k . S p i n b o x ( d i m e n s i o n s _ f r a m e ,   f r o m _ = 1 . 0 ,   t o = 5 0 . 0 ,   i n c r e m e n t = 0 . 5 , 
 
                                                                         t e x t v a r i a b l e = s e l f . w i d t h _ v a r ,   w i d t h = 1 0 ) 
 
                 w i d t h _ s p i n b o x . g r i d ( r o w = 0 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   A l t e z z a 
 
                 t t k . L a b e l ( d i m e n s i o n s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' l a b e l _ h e i g h t ' ,   ' A l t e z z a   ( c m ) ' )   +   ' : ' ) . g r i d ( 
 
                         r o w = 1 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . h e i g h t _ v a r   =   t k . D o u b l e V a r ( v a l u e = 5 . 0 ) 
 
                 h e i g h t _ s p i n b o x   =   t t k . S p i n b o x ( d i m e n s i o n s _ f r a m e ,   f r o m _ = 1 . 0 ,   t o = 5 0 . 0 ,   i n c r e m e n t = 0 . 5 , 
 
                                                                           t e x t v a r i a b l e = s e l f . h e i g h t _ v a r ,   w i d t h = 1 0 ) 
 
                 h e i g h t _ s p i n b o x . g r i d ( r o w = 1 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   = = =   S E Z I O N E   C A M P I   D A   S T A M P A R E   = = = 
 
                 f i e l d s _ f r a m e   =   t t k . L a b e l F r a m e ( s c r o l l a b l e _ f r a m e , 
 
                                                                           t e x t = s e l f . l a n g . g e t ( ' f i e l d s _ t o _ p r i n t _ s e c t i o n ' ,   ' C a m p i   d a   S t a m p a r e ' ) , 
 
                                                                           p a d d i n g = " 1 5 " ) 
 
                 f i e l d s _ f r a m e . p a c k ( f i l l = ' x ' ,   p a d x = 1 0 ,   p a d y = 1 0 ) 
 
                 
 
                 #   H e a d e r 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' f i e l d _ n a m e ' ,   ' C a m p o ' ) ,   
 
                                   f o n t = ( ' A r i a l ' ,   9 ,   ' b o l d ' ) ) . g r i d ( r o w = 0 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' p r i n t _ f i e l d ' ,   ' S t a m p a ' ) ,   
 
                                   f o n t = ( ' A r i a l ' ,   9 ,   ' b o l d ' ) ) . g r i d ( r o w = 0 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' f i e l d _ p o s i t i o n ' ,   ' P o s i z i o n e ' ) ,   
 
                                   f o n t = ( ' A r i a l ' ,   9 ,   ' b o l d ' ) ) . g r i d ( r o w = 0 ,   c o l u m n = 2 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   N u m e r o   O r d i n e 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' p r i n t _ o r d e r _ n u m b e r ' ,   ' N u m e r o   O r d i n e ' ) ) . g r i d ( 
 
                         r o w = 1 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . p r i n t _ o r d e r _ v a r   =   t k . B o o l e a n V a r ( v a l u e = T r u e ) 
 
                 t t k . C h e c k b u t t o n ( f i e l d s _ f r a m e ,   v a r i a b l e = s e l f . p r i n t _ o r d e r _ v a r , 
 
                                               c o m m a n d = s e l f . _ o n _ f i e l d _ t o g g l e ) . g r i d ( r o w = 1 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . o r d e r _ p o s i t i o n _ v a r   =   t k . I n t V a r ( v a l u e = 1 ) 
 
                 s e l f . o r d e r _ p o s i t i o n _ s p i n   =   t t k . S p i n b o x ( f i e l d s _ f r a m e ,   f r o m _ = 1 ,   t o = 4 ,   i n c r e m e n t = 1 , 
 
                                                                                               t e x t v a r i a b l e = s e l f . o r d e r _ p o s i t i o n _ v a r ,   w i d t h = 5 ) 
 
                 s e l f . o r d e r _ p o s i t i o n _ s p i n . g r i d ( r o w = 1 ,   c o l u m n = 2 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   C o d i c e   M a t e r i a l e 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' p r i n t _ m a t e r i a l _ c o d e ' ,   ' C o d i c e   M a t e r i a l e ' ) ) . g r i d ( 
 
                         r o w = 2 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . p r i n t _ m a t e r i a l _ v a r   =   t k . B o o l e a n V a r ( v a l u e = T r u e ) 
 
                 t t k . C h e c k b u t t o n ( f i e l d s _ f r a m e ,   v a r i a b l e = s e l f . p r i n t _ m a t e r i a l _ v a r , 
 
                                               c o m m a n d = s e l f . _ o n _ f i e l d _ t o g g l e ) . g r i d ( r o w = 2 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . m a t e r i a l _ p o s i t i o n _ v a r   =   t k . I n t V a r ( v a l u e = 2 ) 
 
                 s e l f . m a t e r i a l _ p o s i t i o n _ s p i n   =   t t k . S p i n b o x ( f i e l d s _ f r a m e ,   f r o m _ = 1 ,   t o = 4 ,   i n c r e m e n t = 1 , 
 
                                                                                                   t e x t v a r i a b l e = s e l f . m a t e r i a l _ p o s i t i o n _ v a r ,   w i d t h = 5 ) 
 
                 s e l f . m a t e r i a l _ p o s i t i o n _ s p i n . g r i d ( r o w = 2 ,   c o l u m n = 2 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   Q u a n t i t ÔøΩ ÔøΩ   C o m p o n e n t i 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' p r i n t _ c o m p o n e n t _ q t y ' ,   ' Q u a n t i t ÔøΩ ÔøΩ   C o m p o n e n t i ' ) ) . g r i d ( 
 
                         r o w = 3 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . p r i n t _ q t y _ v a r   =   t k . B o o l e a n V a r ( v a l u e = T r u e ) 
 
                 t t k . C h e c k b u t t o n ( f i e l d s _ f r a m e ,   v a r i a b l e = s e l f . p r i n t _ q t y _ v a r , 
 
                                               c o m m a n d = s e l f . _ o n _ f i e l d _ t o g g l e ) . g r i d ( r o w = 3 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . q t y _ p o s i t i o n _ v a r   =   t k . I n t V a r ( v a l u e = 3 ) 
 
                 s e l f . q t y _ p o s i t i o n _ s p i n   =   t t k . S p i n b o x ( f i e l d s _ f r a m e ,   f r o m _ = 1 ,   t o = 4 ,   i n c r e m e n t = 1 , 
 
                                                                                         t e x t v a r i a b l e = s e l f . q t y _ p o s i t i o n _ v a r ,   w i d t h = 5 ) 
 
                 s e l f . q t y _ p o s i t i o n _ s p i n . g r i d ( r o w = 3 ,   c o l u m n = 2 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   R i f e r i m e n t i   S c h e d a 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   t e x t = s e l f . l a n g . g e t ( ' p r i n t _ r e f e r e n c e s ' ,   ' R i f e r i m e n t i   S c h e d a ' ) ) . g r i d ( 
 
                         r o w = 4 ,   c o l u m n = 0 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . p r i n t _ r e f s _ v a r   =   t k . B o o l e a n V a r ( v a l u e = T r u e ) 
 
                 t t k . C h e c k b u t t o n ( f i e l d s _ f r a m e ,   v a r i a b l e = s e l f . p r i n t _ r e f s _ v a r , 
 
                                               c o m m a n d = s e l f . _ o n _ f i e l d _ t o g g l e ) . g r i d ( r o w = 4 ,   c o l u m n = 1 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 s e l f . r e f s _ p o s i t i o n _ v a r   =   t k . I n t V a r ( v a l u e = 4 ) 
 
                 s e l f . r e f s _ p o s i t i o n _ s p i n   =   t t k . S p i n b o x ( f i e l d s _ f r a m e ,   f r o m _ = 1 ,   t o = 4 ,   i n c r e m e n t = 1 , 
 
                                                                                           t e x t v a r i a b l e = s e l f . r e f s _ p o s i t i o n _ v a r ,   w i d t h = 5 ) 
 
                 s e l f . r e f s _ p o s i t i o n _ s p i n . g r i d ( r o w = 4 ,   c o l u m n = 2 ,   s t i c k y = ' w ' ,   p a d x = 5 ,   p a d y = 5 ) 
 
                 
 
                 #   I n f o 
 
                 t t k . L a b e l ( f i e l d s _ f r a m e ,   
 
                                   t e x t = s e l f . l a n g . g e t ( ' p o s i t i o n _ i n f o ' ,   ' L a   p o s i z i o n e   d e t e r m i n a   l \ ' o r d i n e   d i   s t a m p a   ( 1 = p r i m o ,   4 = u l t i m o ) ' ) , 
 
                                   f o n t = ( ' A r i a l ' ,   8 ) ,   f o r e g r o u n d = ' g r a y ' ) . g r i d ( r o w = 5 ,   c o l u m n = 0 ,   c o l u m n s p a n = 3 ,   s t i c k y = ' w ' ,   p a d y = 1 0 ) 
 
                 
 
                 #   F r a m e   p u l s a n t i 
 
                 b u t t o n _ f r a m e   =   t t k . F r a m e ( s e l f ,   p a d d i n g = " 1 0 " ) 
 
                 b u t t o n _ f r a m e . p a c k ( f i l l = ' x ' ,   p a d x = 1 0 ,   p a d y = 1 0 ) 
 
                 
 
                 t t k . B u t t o n ( b u t t o n _ f r a m e ,   t e x t = ' ÔøΩ x ÔøΩ   '   +   s e l f . l a n g . g e t ( ' s a v e _ b u t t o n ' ,   ' S a l v a ' ) , 
 
                                     c o m m a n d = s e l f . _ s a v e _ c o n f i g u r a t i o n ) . p a c k ( s i d e = ' r i g h t ' ,   p a d x = 5 ) 
 
                 t t k . B u t t o n ( b u t t o n _ f r a m e ,   t e x t = ' ÔøΩ ÔøΩ R  '   +   s e l f . l a n g . g e t ( ' c a n c e l _ b u t t o n ' ,   ' A n n u l l a ' ) , 
 
                                     c o m m a n d = s e l f . d e s t r o y ) . p a c k ( s i d e = ' r i g h t ' ,   p a d x = 5 ) 
 
         
 
         d e f   _ o n _ f i e l d _ t o g g l e ( s e l f ) : 
 
                 " " " G e s t i s c e   l ' a b i l i t a z i o n e / d i s a b i l i t a z i o n e   d e i   c o n t r o l l i   p o s i z i o n e . " " " 
 
                 s e l f . o r d e r _ p o s i t i o n _ s p i n . c o n f i g ( s t a t e = ' n o r m a l '   i f   s e l f . p r i n t _ o r d e r _ v a r . g e t ( )   e l s e   ' d i s a b l e d ' ) 
 
                 s e l f . m a t e r i a l _ p o s i t i o n _ s p i n . c o n f i g ( s t a t e = ' n o r m a l '   i f   s e l f . p r i n t _ m a t e r i a l _ v a r . g e t ( )   e l s e   ' d i s a b l e d ' ) 
 
                 s e l f . q t y _ p o s i t i o n _ s p i n . c o n f i g ( s t a t e = ' n o r m a l '   i f   s e l f . p r i n t _ q t y _ v a r . g e t ( )   e l s e   ' d i s a b l e d ' ) 
 
                 s e l f . r e f s _ p o s i t i o n _ s p i n . c o n f i g ( s t a t e = ' n o r m a l '   i f   s e l f . p r i n t _ r e f s _ v a r . g e t ( )   e l s e   ' d i s a b l e d ' ) 
 
         
 
         d e f   _ l o a d _ c o n f i g u r a t i o n ( s e l f ) : 
 
                 " " " C a r i c a   l a   c o n f i g u r a z i o n e   c o r r e n t e   d a l   d a t a b a s e . " " " 
 
                 t r y : 
 
                         c u r s o r   =   s e l f . d b . c o n n . c u r s o r ( ) 
 
                         q u e r y   =   " " " 
 
                         S E L E C T   T O P   1   
 
                                 C o n f i g I D ,   L a b e l W i d t h ,   L a b e l H e i g h t , 
 
                                 P r i n t O r d e r N u m b e r ,   P r i n t M a t e r i a l C o d e ,   P r i n t C o m p o n e n t Q u a n t i t y ,   P r i n t R e f e r e n c e s , 
 
                                 O r d e r N u m b e r P o s i t i o n ,   M a t e r i a l C o d e P o s i t i o n ,   C o m p o n e n t Q u a n t i t y P o s i t i o n ,   R e f e r e n c e s P o s i t i o n 
 
                         F R O M   [ T r a c e a b i l i t y _ R S ] . [ d b o ] . [ L a b e l C o n f i g u r a t i o n ] 
 
                         W H E R E   I s A c t i v e   =   1 
 
                         O R D E R   B Y   C o n f i g I D   D E S C 
 
                         " " " 
 
                         c u r s o r . e x e c u t e ( q u e r y ) 
 
                         r o w   =   c u r s o r . f e t c h o n e ( ) 
 
                         c u r s o r . c l o s e ( ) 
 
                         
 
                         i f   r o w : 
 
                                 ( s e l f . c o n f i g _ i d ,   w i d t h ,   h e i g h t , 
 
                                   p r i n t _ o r d e r ,   p r i n t _ m a t e r i a l ,   p r i n t _ q t y ,   p r i n t _ r e f s , 
 
                                   o r d e r _ p o s ,   m a t e r i a l _ p o s ,   q t y _ p o s ,   r e f s _ p o s )   =   r o w 
 
                                 
 
                                 #   I m p o s t a   i   v a l o r i 
 
                                 s e l f . w i d t h _ v a r . s e t ( f l o a t ( w i d t h )   i f   w i d t h   e l s e   1 0 . 0 ) 
 
                                 s e l f . h e i g h t _ v a r . s e t ( f l o a t ( h e i g h t )   i f   h e i g h t   e l s e   5 . 0 ) 
 
                                 
 
                                 s e l f . p r i n t _ o r d e r _ v a r . s e t ( b o o l ( p r i n t _ o r d e r ) ) 
 
                                 s e l f . p r i n t _ m a t e r i a l _ v a r . s e t ( b o o l ( p r i n t _ m a t e r i a l ) ) 
 
                                 s e l f . p r i n t _ q t y _ v a r . s e t ( b o o l ( p r i n t _ q t y ) ) 
 
                                 s e l f . p r i n t _ r e f s _ v a r . s e t ( b o o l ( p r i n t _ r e f s ) ) 
 
                                 
 
                                 s e l f . o r d e r _ p o s i t i o n _ v a r . s e t ( o r d e r _ p o s   i f   o r d e r _ p o s   e l s e   1 ) 
 
                                 s e l f . m a t e r i a l _ p o s i t i o n _ v a r . s e t ( m a t e r i a l _ p o s   i f   m a t e r i a l _ p o s   e l s e   2 ) 
 
                                 s e l f . q t y _ p o s i t i o n _ v a r . s e t ( q t y _ p o s   i f   q t y _ p o s   e l s e   3 ) 
 
                                 s e l f . r e f s _ p o s i t i o n _ v a r . s e t ( r e f s _ p o s   i f   r e f s _ p o s   e l s e   4 ) 
 
                                 
 
                                 s e l f . _ o n _ f i e l d _ t o g g l e ( ) 
 
                                 
 
                                 l o g g e r . i n f o ( f " C o n f i g u r a z i o n e   c a r i c a t a :   I D = { s e l f . c o n f i g _ i d } " ) 
 
                         e l s e : 
 
                                 l o g g e r . w a r n i n g ( " N e s s u n a   c o n f i g u r a z i o n e   t r o v a t a ,   u s o   v a l o r i   d i   d e f a u l t " ) 
 
                                 s e l f . _ o n _ f i e l d _ t o g g l e ( ) 
 
                 
 
                 e x c e p t   E x c e p t i o n   a s   e : 
 
                         l o g g e r . e r r o r ( f " E r r o r e   c a r i c a m e n t o   c o n f i g u r a z i o n e :   { e } " ) 
 
                         m e s s a g e b o x . s h o w e r r o r ( 
 
                                 s e l f . l a n g . g e t ( ' e r r o r _ t i t l e ' ,   ' E r r o r e ' ) , 
 
                                 f " E r r o r e   c a r i c a m e n t o   c o n f i g u r a z i o n e : \ n { e } " , 
 
                                 p a r e n t = s e l f 
 
                         ) 
 
         
 
         d e f   _ s a v e _ c o n f i g u r a t i o n ( s e l f ) : 
 
                 " " " S a l v a   l a   c o n f i g u r a z i o n e   n e l   d a t a b a s e . " " " 
 
                 t r y : 
 
                         #   V a l i d a z i o n e 
 
                         w i d t h   =   s e l f . w i d t h _ v a r . g e t ( ) 
 
                         h e i g h t   =   s e l f . h e i g h t _ v a r . g e t ( ) 
 
                         
 
                         i f   w i d t h   < =   0   o r   h e i g h t   < =   0 : 
 
                                 m e s s a g e b o x . s h o w w a r n i n g ( 
 
                                         s e l f . l a n g . g e t ( ' w a r n i n g _ t i t l e ' ,   ' A t t e n z i o n e ' ) , 
 
                                         s e l f . l a n g . g e t ( ' i n v a l i d _ d i m e n s i o n s ' ,   ' L e   d i m e n s i o n i   d e v o n o   e s s e r e   m a g g i o r i   d i   z e r o ' ) , 
 
                                         p a r e n t = s e l f 
 
                                 ) 
 
                                 r e t u r n 
 
                         
 
                         #   V e r i f i c a   c h e   a l m e n o   u n   c a m p o   s i a   s e l e z i o n a t o 
 
                         i f   n o t   a n y ( [ s e l f . p r i n t _ o r d e r _ v a r . g e t ( ) ,   s e l f . p r i n t _ m a t e r i a l _ v a r . g e t ( ) , 
 
                                               s e l f . p r i n t _ q t y _ v a r . g e t ( ) ,   s e l f . p r i n t _ r e f s _ v a r . g e t ( ) ] ) : 
 
                                 m e s s a g e b o x . s h o w w a r n i n g ( 
 
                                         s e l f . l a n g . g e t ( ' w a r n i n g _ t i t l e ' ,   ' A t t e n z i o n e ' ) , 
 
                                         s e l f . l a n g . g e t ( ' s e l e c t _ a t _ l e a s t _ o n e _ f i e l d ' ,   ' S e l e z i o n a   a l m e n o   u n   c a m p o   d a   s t a m p a r e ' ) , 
 
                                         p a r e n t = s e l f 
 
                                 ) 
 
                                 r e t u r n 
 
                         
 
                         c u r s o r   =   s e l f . d b . c o n n . c u r s o r ( ) 
 
                         
 
                         i f   s e l f . c o n f i g _ i d : 
 
                                 #   U p d a t e   e s i s t e n t e 
 
                                 q u e r y   =   " " " 
 
                                 U P D A T E   [ T r a c e a b i l i t y _ R S ] . [ d b o ] . [ L a b e l C o n f i g u r a t i o n ] 
 
                                 S E T   L a b e l W i d t h   =   ? , 
 
                                         L a b e l H e i g h t   =   ? , 
 
                                         P r i n t O r d e r N u m b e r   =   ? , 
 
                                         P r i n t M a t e r i a l C o d e   =   ? , 
 
                                         P r i n t C o m p o n e n t Q u a n t i t y   =   ? , 
 
                                         P r i n t R e f e r e n c e s   =   ? , 
 
                                         O r d e r N u m b e r P o s i t i o n   =   ? , 
 
                                         M a t e r i a l C o d e P o s i t i o n   =   ? , 
 
                                         C o m p o n e n t Q u a n t i t y P o s i t i o n   =   ? , 
 
                                         R e f e r e n c e s P o s i t i o n   =   ? , 
 
                                         M o d i f i e d D a t e   =   G E T D A T E ( ) , 
 
                                         M o d i f i e d B y   =   ? 
 
                                 W H E R E   C o n f i g I D   =   ? 
 
                                 " " " 
 
                                 c u r s o r . e x e c u t e ( q u e r y , 
 
                                                           w i d t h ,   h e i g h t , 
 
                                                           s e l f . p r i n t _ o r d e r _ v a r . g e t ( ) ,   s e l f . p r i n t _ m a t e r i a l _ v a r . g e t ( ) , 
 
                                                           s e l f . p r i n t _ q t y _ v a r . g e t ( ) ,   s e l f . p r i n t _ r e f s _ v a r . g e t ( ) , 
 
                                                           s e l f . o r d e r _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ o r d e r _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . m a t e r i a l _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ m a t e r i a l _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . q t y _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ q t y _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . r e f s _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ r e f s _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . u s e r _ n a m e , 
 
                                                           s e l f . c o n f i g _ i d ) 
 
                         e l s e : 
 
                                 #   N u o v o   i n s e r t 
 
                                 q u e r y   =   " " " 
 
                                 I N S E R T   I N T O   [ T r a c e a b i l i t y _ R S ] . [ d b o ] . [ L a b e l C o n f i g u r a t i o n ] 
 
                                         ( L a b e l W i d t h ,   L a b e l H e i g h t ,   P r i n t O r d e r N u m b e r ,   P r i n t M a t e r i a l C o d e , 
 
                                           P r i n t C o m p o n e n t Q u a n t i t y ,   P r i n t R e f e r e n c e s , 
 
                                           O r d e r N u m b e r P o s i t i o n ,   M a t e r i a l C o d e P o s i t i o n , 
 
                                           C o m p o n e n t Q u a n t i t y P o s i t i o n ,   R e f e r e n c e s P o s i t i o n , 
 
                                           C r e a t e d B y ,   M o d i f i e d B y ) 
 
                                 V A L U E S   ( ? ,   ? ,   ? ,   ? ,   ? ,   ? ,   ? ,   ? ,   ? ,   ? ,   ? ,   ? ) 
 
                                 " " " 
 
                                 c u r s o r . e x e c u t e ( q u e r y , 
 
                                                           w i d t h ,   h e i g h t , 
 
                                                           s e l f . p r i n t _ o r d e r _ v a r . g e t ( ) ,   s e l f . p r i n t _ m a t e r i a l _ v a r . g e t ( ) , 
 
                                                           s e l f . p r i n t _ q t y _ v a r . g e t ( ) ,   s e l f . p r i n t _ r e f s _ v a r . g e t ( ) , 
 
                                                           s e l f . o r d e r _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ o r d e r _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . m a t e r i a l _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ m a t e r i a l _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . q t y _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ q t y _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . r e f s _ p o s i t i o n _ v a r . g e t ( )   i f   s e l f . p r i n t _ r e f s _ v a r . g e t ( )   e l s e   N o n e , 
 
                                                           s e l f . u s e r _ n a m e ,   s e l f . u s e r _ n a m e ) 
 
                         
 
                         s e l f . d b . c o n n . c o m m i t ( ) 
 
                         c u r s o r . c l o s e ( ) 
 
                         
 
                         m e s s a g e b o x . s h o w i n f o ( 
 
                                 s e l f . l a n g . g e t ( ' s u c c e s s _ t i t l e ' ,   ' S u c c e s s o ' ) , 
 
                                 s e l f . l a n g . g e t ( ' c o n f i g _ s a v e d ' ,   ' C o n f i g u r a z i o n e   s a l v a t a   c o n   s u c c e s s o ! ' ) , 
 
                                 p a r e n t = s e l f 
 
                         ) 
 
                         l o g g e r . i n f o ( f " C o n f i g u r a z i o n e   e t i c h e t t a   s a l v a t a   d a   { s e l f . u s e r _ n a m e } " ) 
 
                         s e l f . d e s t r o y ( ) 
 
                         
 
                 e x c e p t   E x c e p t i o n   a s   e : 
 
                         l o g g e r . e r r o r ( f " E r r o r e   s a l v a t a g g i o   c o n f i g u r a z i o n e :   { e } " ,   e x c _ i n f o = T r u e ) 
 
                         m e s s a g e b o x . s h o w e r r o r ( 
 
                                 s e l f . l a n g . g e t ( ' e r r o r _ t i t l e ' ,   ' E r r o r e ' ) , 
 
                                 f " E r r o r e   s a l v a t a g g i o   c o n f i g u r a z i o n e : \ n { e } " , 
 
                                 p a r e n t = s e l f 
 
                         ) 
 
 